import { makeStyles } from '@material-ui/core';
import React from 'react';
import { MuiAudioInput } from './MuiAudioInput';
import { MuiFileInput } from './MuiFileInput';
import { MuiMessage } from './MuiMessage';
import { MuiMultiSelectInput } from './MuiMultiSelectInput';
import { MuiSelectInput } from './MuiSelectInput';
import { MuiTextInput } from './MuiTextInput';
const useStyles = makeStyles(theme => ({
  container: {
    height: '100%',
    width: '100%',
    padding: theme.spacing(1),
    backgroundColor: theme.palette.background.default,
    display: 'flex',
    flexDirection: 'column',
    '& > *': {
      maxWidth: '100%'
    },
    '& > * + *': {
      marginTop: theme.spacing(1)
    }
  },
  messages: {
    flex: '1 1 0%',
    overflowY: 'auto',
    WebkitOverflowScrolling: 'touch',
    display: 'flex',
    flexDirection: 'column',
    '& > *': {
      maxWidth: '100%'
    }
  },
  action: {
    flex: '0 1 auto',
    display: 'flex',
    alignContent: 'flex-end',
    '& > *': {
      minWidth: 0
    }
  }
}));
export function MuiChat({
  chatController
}) {
  const classes = useStyles();
  const chatCtl = chatController;
  const [messages, setMessages] = React.useState(chatCtl.getMessages());
  const [actReq, setActReq] = React.useState(chatCtl.getActionRequest());
  const msgRef = React.useRef(null);
  const scroll = React.useCallback(() => {
    if (msgRef.current) {
      msgRef.current.scrollTop = msgRef.current.scrollHeight; // msgRef.current.scrollIntoView(true);
    }
  }, [msgRef]);
  React.useEffect(() => {
    function handleMassagesChanged() {
      setMessages([...chatCtl.getMessages()]);
      scroll();
    }

    function handleActionChanged() {
      setActReq(chatCtl.getActionRequest());
      scroll();
    }

    chatCtl.addOnMessagesChanged(handleMassagesChanged);
    chatCtl.addOnActionChanged(handleActionChanged);
  }, [chatCtl, scroll]);
  const CustomComponent = React.useMemo(() => {
    if (!actReq || actReq.type !== 'custom') {
      return null;
    }

    return actReq.Component;
  }, [actReq]);
  const unknownMsg = {
    type: 'text',
    content: 'Unknown message.',
    self: false
  };
  return /*#__PURE__*/React.createElement("div", {
    className: classes.container
  }, /*#__PURE__*/React.createElement("div", {
    className: classes.messages,
    ref: msgRef
  }, messages.map(msg => {
    if (msg.type === 'text' || msg.type === 'jsx' || msg.type === 'text_audio') {
      return /*#__PURE__*/React.createElement(MuiMessage, {
        key: messages.indexOf(msg),
        id: `cu-msg-${messages.indexOf(msg) + 1}`,
        message: msg,
        showDateTime: !!chatCtl.getOption().showDateTime
      });
    }

    return /*#__PURE__*/React.createElement(MuiMessage, {
      key: messages.indexOf(msg),
      id: `cu-msg-${messages.indexOf(msg) + 1}`,
      message: unknownMsg,
      showDateTime: !!chatCtl.getOption().showDateTime
    });
  })), /*#__PURE__*/React.createElement("div", {
    className: classes.action
  }, actReq && actReq.type === 'text' && /*#__PURE__*/React.createElement(MuiTextInput, {
    chatController: chatCtl,
    actionRequest: actReq
  }), actReq && actReq.type === 'select' && /*#__PURE__*/React.createElement(MuiSelectInput, {
    chatController: chatCtl,
    actionRequest: actReq
  }), actReq && actReq.type === 'multi-select' && /*#__PURE__*/React.createElement(MuiMultiSelectInput, {
    chatController: chatCtl,
    actionRequest: actReq
  }), actReq && actReq.type === 'file' && /*#__PURE__*/React.createElement(MuiFileInput, {
    chatController: chatCtl,
    actionRequest: actReq
  }), actReq && actReq.type === 'audio' && /*#__PURE__*/React.createElement(MuiAudioInput, {
    chatController: chatCtl,
    actionRequest: actReq
  }), actReq && actReq.type === 'custom' && /*#__PURE__*/React.createElement(CustomComponent, {
    chatController: chatCtl,
    actionRequest: actReq
  })));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9tdWkvTXVpQ2hhdC50c3giXSwibmFtZXMiOlsibWFrZVN0eWxlcyIsIlJlYWN0IiwiTXVpQXVkaW9JbnB1dCIsIk11aUZpbGVJbnB1dCIsIk11aU1lc3NhZ2UiLCJNdWlNdWx0aVNlbGVjdElucHV0IiwiTXVpU2VsZWN0SW5wdXQiLCJNdWlUZXh0SW5wdXQiLCJ1c2VTdHlsZXMiLCJ0aGVtZSIsImNvbnRhaW5lciIsImhlaWdodCIsIndpZHRoIiwicGFkZGluZyIsInNwYWNpbmciLCJiYWNrZ3JvdW5kQ29sb3IiLCJwYWxldHRlIiwiYmFja2dyb3VuZCIsImRlZmF1bHQiLCJkaXNwbGF5IiwiZmxleERpcmVjdGlvbiIsIm1heFdpZHRoIiwibWFyZ2luVG9wIiwibWVzc2FnZXMiLCJmbGV4Iiwib3ZlcmZsb3dZIiwiV2Via2l0T3ZlcmZsb3dTY3JvbGxpbmciLCJhY3Rpb24iLCJhbGlnbkNvbnRlbnQiLCJtaW5XaWR0aCIsIk11aUNoYXQiLCJjaGF0Q29udHJvbGxlciIsImNsYXNzZXMiLCJjaGF0Q3RsIiwic2V0TWVzc2FnZXMiLCJ1c2VTdGF0ZSIsImdldE1lc3NhZ2VzIiwiYWN0UmVxIiwic2V0QWN0UmVxIiwiZ2V0QWN0aW9uUmVxdWVzdCIsIm1zZ1JlZiIsInVzZVJlZiIsInNjcm9sbCIsInVzZUNhbGxiYWNrIiwiY3VycmVudCIsInNjcm9sbFRvcCIsInNjcm9sbEhlaWdodCIsInVzZUVmZmVjdCIsImhhbmRsZU1hc3NhZ2VzQ2hhbmdlZCIsImhhbmRsZUFjdGlvbkNoYW5nZWQiLCJhZGRPbk1lc3NhZ2VzQ2hhbmdlZCIsImFkZE9uQWN0aW9uQ2hhbmdlZCIsIkN1c3RvbUNvbXBvbmVudCIsInVzZU1lbW8iLCJ0eXBlIiwiQ29tcG9uZW50IiwidW5rbm93bk1zZyIsImNvbnRlbnQiLCJzZWxmIiwibWFwIiwibXNnIiwiaW5kZXhPZiIsImdldE9wdGlvbiIsInNob3dEYXRlVGltZSJdLCJtYXBwaW5ncyI6IkFBQUEsU0FBZ0JB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QUEsYUFBYSxFQUFFSTtBQUZqQixJQXBCSixFQXlCR0EsTUFBTSxJQUFJQSxNQUFNLENBQUNpQixJQUFQLEtBQWdCLE9BQTFCLGlCQUNDLG9CQUFDLGFBQUQ7QUFDRSxJQUFBLGNBQWMsRUFBRXJCLE9BRGxCO0FBRUUsSUFBQSxhQUFhLEVBQUVJO0FBRmpCLElBMUJKLEVBK0JHQSxNQUFNLElBQUlBLE1BQU0sQ0FBQ2lCLElBQVAsS0FBZ0IsUUFBMUIsaUJBQ0Msb0JBQUMsZUFBRDtBQUNFLElBQUEsY0FBYyxFQUFFckIsT0FEbEI7QUFFRSxJQUFBLGFBQWEsRUFBRUk7QUFGakIsSUFoQ0osQ0F2QkYsQ0FERjtBQWdFRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRoZW1lLCBtYWtlU3R5bGVzIH0gZnJvbSAnQG1hdGVyaWFsLXVpL2NvcmUnO1xuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcblxuaW1wb3J0IHsgQ2hhdENvbnRyb2xsZXIgfSBmcm9tICcuLi9jaGF0LWNvbnRyb2xsZXInO1xuaW1wb3J0IHtcbiAgQWN0aW9uUmVxdWVzdCxcbiAgQXVkaW9BY3Rpb25SZXF1ZXN0LFxuICBDdXN0b21BY3Rpb25SZXF1ZXN0LFxuICBGaWxlQWN0aW9uUmVxdWVzdCxcbiAgTXVsdGlTZWxlY3RBY3Rpb25SZXF1ZXN0LFxuICBTZWxlY3RBY3Rpb25SZXF1ZXN0LFxuICBUZXh0QWN0aW9uUmVxdWVzdCxcbn0gZnJvbSAnLi4vY2hhdC10eXBlcyc7XG5cbmltcG9ydCB7IE11aUF1ZGlvSW5wdXQgfSBmcm9tICcuL011aUF1ZGlvSW5wdXQnO1xuaW1wb3J0IHsgTXVpRmlsZUlucHV0IH0gZnJvbSAnLi9NdWlGaWxlSW5wdXQnO1xuaW1wb3J0IHsgTXVpTWVzc2FnZSB9IGZyb20gJy4vTXVpTWVzc2FnZSc7XG5pbXBvcnQgeyBNdWlNdWx0aVNlbGVjdElucHV0IH0gZnJvbSAnLi9NdWlNdWx0aVNlbGVjdElucHV0JztcbmltcG9ydCB7IE11aVNlbGVjdElucHV0IH0gZnJvbSAnLi9NdWlTZWxlY3RJbnB1dCc7XG5pbXBvcnQgeyBNdWlUZXh0SW5wdXQgfSBmcm9tICcuL011aVRleHRJbnB1dCc7XG5cbmNvbnN0IHVzZVN0eWxlcyA9IG1ha2VTdHlsZXMoKHRoZW1lOiBUaGVtZSkgPT4gKHtcbiAgY29udGFpbmVyOiB7XG4gICAgaGVpZ2h0OiAnMTAwJScsXG4gICAgd2lkdGg6ICcxMDAlJyxcbiAgICBwYWRkaW5nOiB0aGVtZS5zcGFjaW5nKDEpLFxuICAgIGJhY2tncm91bmRDb2xvcjogdGhlbWUucGFsZXR0ZS5iYWNrZ3JvdW5kLmRlZmF1bHQsXG4gICAgZGlzcGxheTogJ2ZsZXgnLFxuICAgIGZsZXhEaXJlY3Rpb246ICdjb2x1bW4nLFxuICAgICcmID4gKic6IHtcbiAgICAgIG1heFdpZHRoOiAnMTAwJScsXG4gICAgfSxcbiAgICAnJiA+ICogKyAqJzoge1xuICAgICAgbWFyZ2luVG9wOiB0aGVtZS5zcGFjaW5nKDEpLFxuICAgIH0sXG4gIH0sXG4gIG1lc3NhZ2VzOiB7XG4gICAgZmxleDogJzEgMSAwJScsXG4gICAgb3ZlcmZsb3dZOiAnYXV0bycsXG4gICAgV2Via2l0T3ZlcmZsb3dTY3JvbGxpbmc6ICd0b3VjaCcsXG4gICAgZGlzcGxheTogJ2ZsZXgnLFxuICAgIGZsZXhEaXJlY3Rpb246ICdjb2x1bW4nLFxuICAgICcmID4gKic6IHtcbiAgICAgIG1heFdpZHRoOiAnMTAwJScsXG4gICAgfSxcbiAgfSxcbiAgYWN0aW9uOiB7XG4gICAgZmxleDogJzAgMSBhdXRvJyxcbiAgICBkaXNwbGF5OiAnZmxleCcsXG4gICAgYWxpZ25Db250ZW50OiAnZmxleC1lbmQnLFxuICAgICcmID4gKic6IHtcbiAgICAgIG1pbldpZHRoOiAwLFxuICAgIH0sXG4gIH0sXG59KSk7XG5cbmV4cG9ydCBmdW5jdGlvbiBNdWlDaGF0KHtcbiAgY2hhdENvbnRyb2xsZXIsXG59OiBSZWFjdC5Qcm9wc1dpdGhDaGlsZHJlbjx7XG4gIGNoYXRDb250cm9sbGVyOiBDaGF0Q29udHJvbGxlcjtcbn0+KTogUmVhY3QuUmVhY3RFbGVtZW50IHtcbiAgY29uc3QgY2xhc3NlcyA9IHVzZVN0eWxlcygpO1xuICBjb25zdCBjaGF0Q3RsID0gY2hhdENvbnRyb2xsZXI7XG4gIGNvbnN0IFttZXNzYWdlcywgc2V0TWVzc2FnZXNdID0gUmVhY3QudXNlU3RhdGUoY2hhdEN0bC5nZXRNZXNzYWdlcygpKTtcbiAgY29uc3QgW2FjdFJlcSwgc2V0QWN0UmVxXSA9IFJlYWN0LnVzZVN0YXRlKGNoYXRDdGwuZ2V0QWN0aW9uUmVxdWVzdCgpKTtcblxuICBjb25zdCBtc2dSZWYgPSBSZWFjdC51c2VSZWY8SFRNTERpdkVsZW1lbnQ+KG51bGwpO1xuICBjb25zdCBzY3JvbGwgPSBSZWFjdC51c2VDYWxsYmFjaygoKTogdm9pZCA9PiB7XG4gICAgaWYgKG1zZ1JlZi5jdXJyZW50KSB7XG4gICAgICBtc2dSZWYuY3VycmVudC5zY3JvbGxUb3AgPSBtc2dSZWYuY3VycmVudC5zY3JvbGxIZWlnaHQ7XG4gICAgICAvLyBtc2dSZWYuY3VycmVudC5zY3JvbGxJbnRvVmlldyh0cnVlKTtcbiAgICB9XG4gIH0sIFttc2dSZWZdKTtcbiAgUmVhY3QudXNlRWZmZWN0KCgpID0+IHtcbiAgICBmdW5jdGlvbiBoYW5kbGVNYXNzYWdlc0NoYW5nZWQoKTogdm9pZCB7XG4gICAgICBzZXRNZXNzYWdlcyhbLi4uY2hhdEN0bC5nZXRNZXNzYWdlcygpXSk7XG4gICAgICBzY3JvbGwoKTtcbiAgICB9XG4gICAgZnVuY3Rpb24gaGFuZGxlQWN0aW9uQ2hhbmdlZCgpOiB2b2lkIHtcbiAgICAgIHNldEFjdFJlcShjaGF0Q3RsLmdldEFjdGlvblJlcXVlc3QoKSk7XG4gICAgICBzY3JvbGwoKTtcbiAgICB9XG4gICAgY2hhdEN0bC5hZGRPbk1lc3NhZ2VzQ2hhbmdlZChoYW5kbGVNYXNzYWdlc0NoYW5nZWQpO1xuICAgIGNoYXRDdGwuYWRkT25BY3Rpb25DaGFuZ2VkKGhhbmRsZUFjdGlvbkNoYW5nZWQpO1xuICB9LCBbY2hhdEN0bCwgc2Nyb2xsXSk7XG5cbiAgdHlwZSBDdXN0b21Db21wb25lbnRUeXBlID0gUmVhY3QuRkM8e1xuICAgIGNoYXRDb250cm9sbGVyOiBDaGF0Q29udHJvbGxlcjtcbiAgICBhY3Rpb25SZXF1ZXN0OiBBY3Rpb25SZXF1ZXN0O1xuICB9PjtcbiAgY29uc3QgQ3VzdG9tQ29tcG9uZW50ID0gUmVhY3QudXNlTWVtbygoKTogQ3VzdG9tQ29tcG9uZW50VHlwZSA9PiB7XG4gICAgaWYgKCFhY3RSZXEgfHwgYWN0UmVxLnR5cGUgIT09ICdjdXN0b20nKSB7XG4gICAgICByZXR1cm4gbnVsbCBhcyB1bmtub3duIGFzIEN1c3RvbUNvbXBvbmVudFR5cGU7XG4gICAgfVxuICAgIHJldHVybiAoYWN0UmVxIGFzIEN1c3RvbUFjdGlvblJlcXVlc3QpXG4gICAgICAuQ29tcG9uZW50IGFzIHVua25vd24gYXMgQ3VzdG9tQ29tcG9uZW50VHlwZTtcbiAgfSwgW2FjdFJlcV0pO1xuXG4gIGNvbnN0IHVua25vd25Nc2cgPSB7XG4gICAgdHlwZTogJ3RleHQnLFxuICAgIGNvbnRlbnQ6ICdVbmtub3duIG1lc3NhZ2UuJyxcbiAgICBzZWxmOiBmYWxzZSxcbiAgfTtcblxuICByZXR1cm4gKFxuICAgIDxkaXYgY2xhc3NOYW1lPXtjbGFzc2VzLmNvbnRhaW5lcn0+XG4gICAgICA8ZGl2IGNsYXNzTmFtZT17Y2xhc3Nlcy5tZXNzYWdlc30gcmVmPXttc2dSZWZ9PlxuICAgICAgICB7bWVzc2FnZXMubWFwKChtc2cpOiBSZWFjdC5SZWFjdEVsZW1lbnQgPT4ge1xuICAgICAgICAgIGlmIChtc2cudHlwZSA9PT0gJ3RleHQnIHx8IG1zZy50eXBlID09PSAnanN4JyB8fCBtc2cudHlwZSA9PT0gJ3RleHRfYXVkaW8nKSB7XG4gICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICA8TXVpTWVzc2FnZVxuICAgICAgICAgICAgICAgIGtleT17bWVzc2FnZXMuaW5kZXhPZihtc2cpfVxuICAgICAgICAgICAgICAgIGlkPXtgY3UtbXNnLSR7bWVzc2FnZXMuaW5kZXhPZihtc2cpICsgMX1gfVxuICAgICAgICAgICAgICAgIG1lc3NhZ2U9e21zZ31cbiAgICAgICAgICAgICAgICBzaG93RGF0ZVRpbWU9eyEhY2hhdEN0bC5nZXRPcHRpb24oKS5zaG93RGF0ZVRpbWV9XG4gICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPE11aU1lc3NhZ2VcbiAgICAgICAgICAgICAga2V5PXttZXNzYWdlcy5pbmRleE9mKG1zZyl9XG4gICAgICAgICAgICAgIGlkPXtgY3UtbXNnLSR7bWVzc2FnZXMuaW5kZXhPZihtc2cpICsgMX1gfVxuICAgICAgICAgICAgICBtZXNzYWdlPXt1bmtub3duTXNnfVxuICAgICAgICAgICAgICBzaG93RGF0ZVRpbWU9eyEhY2hhdEN0bC5nZXRPcHRpb24oKS5zaG93RGF0ZVRpbWV9XG4gICAgICAgICAgICAvPlxuICAgICAgICAgICk7XG4gICAgICAgIH0pfVxuICAgICAgPC9kaXY+XG4gICAgICA8ZGl2IGNsYXNzTmFtZT17Y2xhc3Nlcy5hY3Rpb259PlxuICAgICAgICB7YWN0UmVxICYmIGFjdFJlcS50eXBlID09PSAndGV4dCcgJiYgKFxuICAgICAgICAgIDxNdWlUZXh0SW5wdXRcbiAgICAgICAgICAgIGNoYXRDb250cm9sbGVyPXtjaGF0Q3RsfVxuICAgICAgICAgICAgYWN0aW9uUmVxdWVzdD17YWN0UmVxIGFzIFRleHRBY3Rpb25SZXF1ZXN0fVxuICAgICAgICAgIC8+XG4gICAgICAgICl9XG4gICAgICAgIHthY3RSZXEgJiYgYWN0UmVxLnR5cGUgPT09ICdzZWxlY3QnICYmIChcbiAgICAgICAgICA8TXVpU2VsZWN0SW5wdXRcbiAgICAgICAgICAgIGNoYXRDb250cm9sbGVyPXtjaGF0Q3RsfVxuICAgICAgICAgICAgYWN0aW9uUmVxdWVzdD17YWN0UmVxIGFzIFNlbGVjdEFjdGlvblJlcXVlc3R9XG4gICAgICAgICAgLz5cbiAgICAgICAgKX1cbiAgICAgICAge2FjdFJlcSAmJiBhY3RSZXEudHlwZSA9PT0gJ211bHRpLXNlbGVjdCcgJiYgKFxuICAgICAgICAgIDxNdWlNdWx0aVNlbGVjdElucHV0XG4gICAgICAgICAgICBjaGF0Q29udHJvbGxlcj17Y2hhdEN0bH1cbiAgICAgICAgICAgIGFjdGlvblJlcXVlc3Q9e2FjdFJlcSBhcyBNdWx0aVNlbGVjdEFjdGlvblJlcXVlc3R9XG4gICAgICAgICAgLz5cbiAgICAgICAgKX1cbiAgICAgICAge2FjdFJlcSAmJiBhY3RSZXEudHlwZSA9PT0gJ2ZpbGUnICYmIChcbiAgICAgICAgICA8TXVpRmlsZUlucHV0XG4gICAgICAgICAgICBjaGF0Q29udHJvbGxlcj17Y2hhdEN0bH1cbiAgICAgICAgICAgIGFjdGlvblJlcXVlc3Q9e2FjdFJlcSBhcyBGaWxlQWN0aW9uUmVxdWVzdH1cbiAgICAgICAgICAvPlxuICAgICAgICApfVxuICAgICAgICB7YWN0UmVxICYmIGFjdFJlcS50eXBlID09PSAnYXVkaW8nICYmIChcbiAgICAgICAgICA8TXVpQXVkaW9JbnB1dFxuICAgICAgICAgICAgY2hhdENvbnRyb2xsZXI9e2NoYXRDdGx9XG4gICAgICAgICAgICBhY3Rpb25SZXF1ZXN0PXthY3RSZXEgYXMgQXVkaW9BY3Rpb25SZXF1ZXN0fVxuICAgICAgICAgIC8+XG4gICAgICAgICl9XG4gICAgICAgIHthY3RSZXEgJiYgYWN0UmVxLnR5cGUgPT09ICdjdXN0b20nICYmIChcbiAgICAgICAgICA8Q3VzdG9tQ29tcG9uZW50XG4gICAgICAgICAgICBjaGF0Q29udHJvbGxlcj17Y2hhdEN0bH1cbiAgICAgICAgICAgIGFjdGlvblJlcXVlc3Q9e2FjdFJlcSBhcyBDdXN0b21BY3Rpb25SZXF1ZXN0fVxuICAgICAgICAgIC8+XG4gICAgICAgICl9XG4gICAgICA8L2Rpdj5cbiAgICA8L2Rpdj5cbiAgKTtcbn1cbiJdfQ==