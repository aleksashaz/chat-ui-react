import { makeStyles } from '@material-ui/core';
import React from 'react';
import { MuiAudioInput } from './MuiAudioInput';
import { MuiFileInput } from './MuiFileInput';
import { MuiMessage } from './MuiMessage';
import { MuiMultiSelectInput } from './MuiMultiSelectInput';
import { MuiSelectInput } from './MuiSelectInput';
import { MuiTextInput } from './MuiTextInput';
const useStyles = makeStyles(theme => ({
  container: {
    height: '100%',
    width: '100%',
    padding: theme.spacing(1),
    backgroundColor: theme.palette.background.default,
    display: 'flex',
    flexDirection: 'column',
    '& > *': {
      maxWidth: '100%'
    },
    '& > * + *': {
      marginTop: theme.spacing(1)
    }
  },
  messages: {
    flex: '1 1 0%',
    overflowY: 'auto',
    WebkitOverflowScrolling: 'touch',
    display: 'flex',
    flexDirection: 'column',
    '& > *': {
      maxWidth: '100%'
    }
  },
  action: {
    flex: '0 1 auto',
    display: 'flex',
    alignContent: 'flex-end',
    '& > *': {
      minWidth: 0
    }
  }
}));
export function MuiChat({
  chatController
}) {
  const classes = useStyles();
  const chatCtl = chatController;
  const [messages, setMessages] = React.useState(chatCtl.getMessages());
  const [actReq, setActReq] = React.useState(chatCtl.getActionRequest());
  const msgRef = React.useRef(null);
  const scroll = React.useCallback(() => {
    if (msgRef.current) {
      msgRef.current.scrollTop = msgRef.current.scrollHeight; // msgRef.current.scrollIntoView(true);
    }
  }, [msgRef]);
  React.useEffect(() => {
    function handleMassagesChanged() {
      setMessages([...chatCtl.getMessages()]);
      scroll();
    }

    function handleActionChanged() {
      setActReq(chatCtl.getActionRequest());
      scroll();
    }

    chatCtl.addOnMessagesChanged(handleMassagesChanged);
    chatCtl.addOnActionChanged(handleActionChanged);
  }, [chatCtl, scroll]);
  const CustomComponent = React.useMemo(() => {
    if (!actReq || actReq.type !== 'custom') {
      return null;
    }

    return actReq.Component;
  }, [actReq]);
  const unknownMsg = {
    type: 'text',
    content: 'Unknown message.',
    self: false
  };
  return /*#__PURE__*/React.createElement("div", {
    className: classes.container
  }, /*#__PURE__*/React.createElement("div", {
    className: classes.messages,
    ref: msgRef
  }, messages.map(msg => {
    if (msg.type === 'text' || msg.type === 'jsx') {
      return /*#__PURE__*/React.createElement(MuiMessage, {
        key: messages.indexOf(msg),
        id: `cu-msg-${messages.indexOf(msg) + 1}`,
        message: msg,
        showDateTime: !!chatCtl.getOption().showDateTime
      });
    }

    return /*#__PURE__*/React.createElement(MuiMessage, {
      key: messages.indexOf(msg),
      id: `cu-msg-${messages.indexOf(msg) + 1}`,
      message: unknownMsg,
      showDateTime: !!chatCtl.getOption().showDateTime
    });
  })), /*#__PURE__*/React.createElement("div", {
    className: classes.action
  }, actReq && actReq.type === 'text' && /*#__PURE__*/React.createElement(MuiTextInput, {
    chatController: chatCtl,
    actionRequest: actReq
  }), actReq && actReq.type === 'select' && /*#__PURE__*/React.createElement(MuiSelectInput, {
    chatController: chatCtl,
    actionRequest: actReq
  }), actReq && actReq.type === 'multi-select' && /*#__PURE__*/React.createElement(MuiMultiSelectInput, {
    chatController: chatCtl,
    actionRequest: actReq
  }), actReq && actReq.type === 'file' && /*#__PURE__*/React.createElement(MuiFileInput, {
    chatController: chatCtl,
    actionRequest: actReq
  }), actReq && actReq.type === 'audio' && /*#__PURE__*/React.createElement(MuiAudioInput, {
    chatController: chatCtl,
    actionRequest: actReq
  }), actReq && actReq.type === 'custom' && /*#__PURE__*/React.createElement(CustomComponent, {
    chatController: chatCtl,
    actionRequest: actReq
  })));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9tdWkvTXVpQ2hhdC50c3giXSwibmFtZXMiOlsibWFrZVN0eWxlcyIsIlJlYWN0IiwiTXVpQXVkaW9JbnB1dCIsIk11aUZpbGVJbnB1dCIsIk11aU1lc3NhZ2UiLCJNdWlNdWx0aVNlbGVjdElucHV0IiwiTXVpU2VsZWN0SW5wdXQiLCJNdWlUZXh0SW5wdXQiLCJ1c2VTdHlsZXMiLCJ0aGVtZSIsImNvbnRhaW5lciIsImhlaWdodCIsIndpZHRoIiwicGFkZGluZyIsInNwYWNpbmciLCJiYWNrZ3JvdW5kQ29sb3IiLCJwYWxldHRlIiwiYmFja2dyb3VuZCIsImRlZmF1bHQiLCJkaXNwbGF5IiwiZmxleERpcmVjdGlvbiIsIm1heFdpZHRoIiwibWFyZ2luVG9wIiwibWVzc2FnZXMiLCJmbGV4Iiwib3ZlcmZsb3dZIiwiV2Via2l0T3ZlcmZsb3dTY3JvbGxpbmciLCJhY3Rpb24iLCJhbGlnbkNvbnRlbnQiLCJtaW5XaWR0aCIsIk11aUNoYXQiLCJjaGF0Q29udHJvbGxlciIsImNsYXNzZXMiLCJjaGF0Q3RsIiwic2V0TWVzc2FnZXMiLCJ1c2VTdGF0ZSIsImdldE1lc3NhZ2VzIiwiYWN0UmVxIiwic2V0QWN0UmVxIiwiZ2V0QWN0aW9uUmVxdWVzdCIsIm1zZ1JlZiIsInVzZVJlZiIsInNjcm9sbCIsInVzZUNhbGxiYWNrIiwiY3VycmVudCIsInNjcm9sbFRvcCIsInNjcm9sbEhlaWdodCIsInVzZUVmZmVjdCIsImhhbmRsZU1hc3NhZ2VzQ2hhbmdlZCIsImhhbmRsZUFjdGlvbkNoYW5nZWQiLCJhZGRPbk1lc3NhZ2VzQ2hhbmdlZCIsImFkZE9uQWN0aW9uQ2hhbmdlZCIsIkN1c3RvbUNvbXBvbmVudCIsInVzZU1lbW8iLCJ0eXBlIiwiQ29tcG9uZW50IiwidW5rbm93bk1zZyIsImNvbnRlbnQiLCJzZWxmIiwibWFwIiwibXNnIiwiaW5kZXhPZiIsImdldE9wdGlvbiIsInNob3dEYXRlVGltZSJdLCJtYXBwaW5ncyI6IkFBQUEsU0FBZ0JB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QUFNLElBQUlBLE1BQU0sQ0FBQ2lCLElBQVAsS0FBZ0IsT0FBMUIsaUJBQ0Msb0JBQUMsYUFBRDtBQUNFLElBQUEsY0FBYyxFQUFFckIsT0FEbEI7QUFFRSxJQUFBLGFBQWEsRUFBRUk7QUFGakIsSUExQkosRUErQkdBLE1BQU0sSUFBSUEsTUFBTSxDQUFDaUIsSUFBUCxLQUFnQixRQUExQixpQkFDQyxvQkFBQyxlQUFEO0FBQ0UsSUFBQSxjQUFjLEVBQUVyQixPQURsQjtBQUVFLElBQUEsYUFBYSxFQUFFSTtBQUZqQixJQWhDSixDQXZCRixDQURGO0FBZ0VEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGhlbWUsIG1ha2VTdHlsZXMgfSBmcm9tICdAbWF0ZXJpYWwtdWkvY29yZSc7XG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuXG5pbXBvcnQgeyBDaGF0Q29udHJvbGxlciB9IGZyb20gJy4uL2NoYXQtY29udHJvbGxlcic7XG5pbXBvcnQge1xuICBBY3Rpb25SZXF1ZXN0LFxuICBBdWRpb0FjdGlvblJlcXVlc3QsXG4gIEN1c3RvbUFjdGlvblJlcXVlc3QsXG4gIEZpbGVBY3Rpb25SZXF1ZXN0LFxuICBNdWx0aVNlbGVjdEFjdGlvblJlcXVlc3QsXG4gIFNlbGVjdEFjdGlvblJlcXVlc3QsXG4gIFRleHRBY3Rpb25SZXF1ZXN0LFxufSBmcm9tICcuLi9jaGF0LXR5cGVzJztcblxuaW1wb3J0IHsgTXVpQXVkaW9JbnB1dCB9IGZyb20gJy4vTXVpQXVkaW9JbnB1dCc7XG5pbXBvcnQgeyBNdWlGaWxlSW5wdXQgfSBmcm9tICcuL011aUZpbGVJbnB1dCc7XG5pbXBvcnQgeyBNdWlNZXNzYWdlIH0gZnJvbSAnLi9NdWlNZXNzYWdlJztcbmltcG9ydCB7IE11aU11bHRpU2VsZWN0SW5wdXQgfSBmcm9tICcuL011aU11bHRpU2VsZWN0SW5wdXQnO1xuaW1wb3J0IHsgTXVpU2VsZWN0SW5wdXQgfSBmcm9tICcuL011aVNlbGVjdElucHV0JztcbmltcG9ydCB7IE11aVRleHRJbnB1dCB9IGZyb20gJy4vTXVpVGV4dElucHV0JztcblxuY29uc3QgdXNlU3R5bGVzID0gbWFrZVN0eWxlcygodGhlbWU6IFRoZW1lKSA9PiAoe1xuICBjb250YWluZXI6IHtcbiAgICBoZWlnaHQ6ICcxMDAlJyxcbiAgICB3aWR0aDogJzEwMCUnLFxuICAgIHBhZGRpbmc6IHRoZW1lLnNwYWNpbmcoMSksXG4gICAgYmFja2dyb3VuZENvbG9yOiB0aGVtZS5wYWxldHRlLmJhY2tncm91bmQuZGVmYXVsdCxcbiAgICBkaXNwbGF5OiAnZmxleCcsXG4gICAgZmxleERpcmVjdGlvbjogJ2NvbHVtbicsXG4gICAgJyYgPiAqJzoge1xuICAgICAgbWF4V2lkdGg6ICcxMDAlJyxcbiAgICB9LFxuICAgICcmID4gKiArIConOiB7XG4gICAgICBtYXJnaW5Ub3A6IHRoZW1lLnNwYWNpbmcoMSksXG4gICAgfSxcbiAgfSxcbiAgbWVzc2FnZXM6IHtcbiAgICBmbGV4OiAnMSAxIDAlJyxcbiAgICBvdmVyZmxvd1k6ICdhdXRvJyxcbiAgICBXZWJraXRPdmVyZmxvd1Njcm9sbGluZzogJ3RvdWNoJyxcbiAgICBkaXNwbGF5OiAnZmxleCcsXG4gICAgZmxleERpcmVjdGlvbjogJ2NvbHVtbicsXG4gICAgJyYgPiAqJzoge1xuICAgICAgbWF4V2lkdGg6ICcxMDAlJyxcbiAgICB9LFxuICB9LFxuICBhY3Rpb246IHtcbiAgICBmbGV4OiAnMCAxIGF1dG8nLFxuICAgIGRpc3BsYXk6ICdmbGV4JyxcbiAgICBhbGlnbkNvbnRlbnQ6ICdmbGV4LWVuZCcsXG4gICAgJyYgPiAqJzoge1xuICAgICAgbWluV2lkdGg6IDAsXG4gICAgfSxcbiAgfSxcbn0pKTtcblxuZXhwb3J0IGZ1bmN0aW9uIE11aUNoYXQoe1xuICBjaGF0Q29udHJvbGxlcixcbn06IFJlYWN0LlByb3BzV2l0aENoaWxkcmVuPHtcbiAgY2hhdENvbnRyb2xsZXI6IENoYXRDb250cm9sbGVyO1xufT4pOiBSZWFjdC5SZWFjdEVsZW1lbnQge1xuICBjb25zdCBjbGFzc2VzID0gdXNlU3R5bGVzKCk7XG4gIGNvbnN0IGNoYXRDdGwgPSBjaGF0Q29udHJvbGxlcjtcbiAgY29uc3QgW21lc3NhZ2VzLCBzZXRNZXNzYWdlc10gPSBSZWFjdC51c2VTdGF0ZShjaGF0Q3RsLmdldE1lc3NhZ2VzKCkpO1xuICBjb25zdCBbYWN0UmVxLCBzZXRBY3RSZXFdID0gUmVhY3QudXNlU3RhdGUoY2hhdEN0bC5nZXRBY3Rpb25SZXF1ZXN0KCkpO1xuXG4gIGNvbnN0IG1zZ1JlZiA9IFJlYWN0LnVzZVJlZjxIVE1MRGl2RWxlbWVudD4obnVsbCk7XG4gIGNvbnN0IHNjcm9sbCA9IFJlYWN0LnVzZUNhbGxiYWNrKCgpOiB2b2lkID0+IHtcbiAgICBpZiAobXNnUmVmLmN1cnJlbnQpIHtcbiAgICAgIG1zZ1JlZi5jdXJyZW50LnNjcm9sbFRvcCA9IG1zZ1JlZi5jdXJyZW50LnNjcm9sbEhlaWdodDtcbiAgICAgIC8vIG1zZ1JlZi5jdXJyZW50LnNjcm9sbEludG9WaWV3KHRydWUpO1xuICAgIH1cbiAgfSwgW21zZ1JlZl0pO1xuICBSZWFjdC51c2VFZmZlY3QoKCkgPT4ge1xuICAgIGZ1bmN0aW9uIGhhbmRsZU1hc3NhZ2VzQ2hhbmdlZCgpOiB2b2lkIHtcbiAgICAgIHNldE1lc3NhZ2VzKFsuLi5jaGF0Q3RsLmdldE1lc3NhZ2VzKCldKTtcbiAgICAgIHNjcm9sbCgpO1xuICAgIH1cbiAgICBmdW5jdGlvbiBoYW5kbGVBY3Rpb25DaGFuZ2VkKCk6IHZvaWQge1xuICAgICAgc2V0QWN0UmVxKGNoYXRDdGwuZ2V0QWN0aW9uUmVxdWVzdCgpKTtcbiAgICAgIHNjcm9sbCgpO1xuICAgIH1cbiAgICBjaGF0Q3RsLmFkZE9uTWVzc2FnZXNDaGFuZ2VkKGhhbmRsZU1hc3NhZ2VzQ2hhbmdlZCk7XG4gICAgY2hhdEN0bC5hZGRPbkFjdGlvbkNoYW5nZWQoaGFuZGxlQWN0aW9uQ2hhbmdlZCk7XG4gIH0sIFtjaGF0Q3RsLCBzY3JvbGxdKTtcblxuICB0eXBlIEN1c3RvbUNvbXBvbmVudFR5cGUgPSBSZWFjdC5GQzx7XG4gICAgY2hhdENvbnRyb2xsZXI6IENoYXRDb250cm9sbGVyO1xuICAgIGFjdGlvblJlcXVlc3Q6IEFjdGlvblJlcXVlc3Q7XG4gIH0+O1xuICBjb25zdCBDdXN0b21Db21wb25lbnQgPSBSZWFjdC51c2VNZW1vKCgpOiBDdXN0b21Db21wb25lbnRUeXBlID0+IHtcbiAgICBpZiAoIWFjdFJlcSB8fCBhY3RSZXEudHlwZSAhPT0gJ2N1c3RvbScpIHtcbiAgICAgIHJldHVybiBudWxsIGFzIHVua25vd24gYXMgQ3VzdG9tQ29tcG9uZW50VHlwZTtcbiAgICB9XG4gICAgcmV0dXJuIChhY3RSZXEgYXMgQ3VzdG9tQWN0aW9uUmVxdWVzdClcbiAgICAgIC5Db21wb25lbnQgYXMgdW5rbm93biBhcyBDdXN0b21Db21wb25lbnRUeXBlO1xuICB9LCBbYWN0UmVxXSk7XG5cbiAgY29uc3QgdW5rbm93bk1zZyA9IHtcbiAgICB0eXBlOiAndGV4dCcsXG4gICAgY29udGVudDogJ1Vua25vd24gbWVzc2FnZS4nLFxuICAgIHNlbGY6IGZhbHNlLFxuICB9O1xuXG4gIHJldHVybiAoXG4gICAgPGRpdiBjbGFzc05hbWU9e2NsYXNzZXMuY29udGFpbmVyfT5cbiAgICAgIDxkaXYgY2xhc3NOYW1lPXtjbGFzc2VzLm1lc3NhZ2VzfSByZWY9e21zZ1JlZn0+XG4gICAgICAgIHttZXNzYWdlcy5tYXAoKG1zZyk6IFJlYWN0LlJlYWN0RWxlbWVudCA9PiB7XG4gICAgICAgICAgaWYgKG1zZy50eXBlID09PSAndGV4dCcgfHwgbXNnLnR5cGUgPT09ICdqc3gnKSB7XG4gICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICA8TXVpTWVzc2FnZVxuICAgICAgICAgICAgICAgIGtleT17bWVzc2FnZXMuaW5kZXhPZihtc2cpfVxuICAgICAgICAgICAgICAgIGlkPXtgY3UtbXNnLSR7bWVzc2FnZXMuaW5kZXhPZihtc2cpICsgMX1gfVxuICAgICAgICAgICAgICAgIG1lc3NhZ2U9e21zZ31cbiAgICAgICAgICAgICAgICBzaG93RGF0ZVRpbWU9eyEhY2hhdEN0bC5nZXRPcHRpb24oKS5zaG93RGF0ZVRpbWV9XG4gICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPE11aU1lc3NhZ2VcbiAgICAgICAgICAgICAga2V5PXttZXNzYWdlcy5pbmRleE9mKG1zZyl9XG4gICAgICAgICAgICAgIGlkPXtgY3UtbXNnLSR7bWVzc2FnZXMuaW5kZXhPZihtc2cpICsgMX1gfVxuICAgICAgICAgICAgICBtZXNzYWdlPXt1bmtub3duTXNnfVxuICAgICAgICAgICAgICBzaG93RGF0ZVRpbWU9eyEhY2hhdEN0bC5nZXRPcHRpb24oKS5zaG93RGF0ZVRpbWV9XG4gICAgICAgICAgICAvPlxuICAgICAgICAgICk7XG4gICAgICAgIH0pfVxuICAgICAgPC9kaXY+XG4gICAgICA8ZGl2IGNsYXNzTmFtZT17Y2xhc3Nlcy5hY3Rpb259PlxuICAgICAgICB7YWN0UmVxICYmIGFjdFJlcS50eXBlID09PSAndGV4dCcgJiYgKFxuICAgICAgICAgIDxNdWlUZXh0SW5wdXRcbiAgICAgICAgICAgIGNoYXRDb250cm9sbGVyPXtjaGF0Q3RsfVxuICAgICAgICAgICAgYWN0aW9uUmVxdWVzdD17YWN0UmVxIGFzIFRleHRBY3Rpb25SZXF1ZXN0fVxuICAgICAgICAgIC8+XG4gICAgICAgICl9XG4gICAgICAgIHthY3RSZXEgJiYgYWN0UmVxLnR5cGUgPT09ICdzZWxlY3QnICYmIChcbiAgICAgICAgICA8TXVpU2VsZWN0SW5wdXRcbiAgICAgICAgICAgIGNoYXRDb250cm9sbGVyPXtjaGF0Q3RsfVxuICAgICAgICAgICAgYWN0aW9uUmVxdWVzdD17YWN0UmVxIGFzIFNlbGVjdEFjdGlvblJlcXVlc3R9XG4gICAgICAgICAgLz5cbiAgICAgICAgKX1cbiAgICAgICAge2FjdFJlcSAmJiBhY3RSZXEudHlwZSA9PT0gJ211bHRpLXNlbGVjdCcgJiYgKFxuICAgICAgICAgIDxNdWlNdWx0aVNlbGVjdElucHV0XG4gICAgICAgICAgICBjaGF0Q29udHJvbGxlcj17Y2hhdEN0bH1cbiAgICAgICAgICAgIGFjdGlvblJlcXVlc3Q9e2FjdFJlcSBhcyBNdWx0aVNlbGVjdEFjdGlvblJlcXVlc3R9XG4gICAgICAgICAgLz5cbiAgICAgICAgKX1cbiAgICAgICAge2FjdFJlcSAmJiBhY3RSZXEudHlwZSA9PT0gJ2ZpbGUnICYmIChcbiAgICAgICAgICA8TXVpRmlsZUlucHV0XG4gICAgICAgICAgICBjaGF0Q29udHJvbGxlcj17Y2hhdEN0bH1cbiAgICAgICAgICAgIGFjdGlvblJlcXVlc3Q9e2FjdFJlcSBhcyBGaWxlQWN0aW9uUmVxdWVzdH1cbiAgICAgICAgICAvPlxuICAgICAgICApfVxuICAgICAgICB7YWN0UmVxICYmIGFjdFJlcS50eXBlID09PSAnYXVkaW8nICYmIChcbiAgICAgICAgICA8TXVpQXVkaW9JbnB1dFxuICAgICAgICAgICAgY2hhdENvbnRyb2xsZXI9e2NoYXRDdGx9XG4gICAgICAgICAgICBhY3Rpb25SZXF1ZXN0PXthY3RSZXEgYXMgQXVkaW9BY3Rpb25SZXF1ZXN0fVxuICAgICAgICAgIC8+XG4gICAgICAgICl9XG4gICAgICAgIHthY3RSZXEgJiYgYWN0UmVxLnR5cGUgPT09ICdjdXN0b20nICYmIChcbiAgICAgICAgICA8Q3VzdG9tQ29tcG9uZW50XG4gICAgICAgICAgICBjaGF0Q29udHJvbGxlcj17Y2hhdEN0bH1cbiAgICAgICAgICAgIGFjdGlvblJlcXVlc3Q9e2FjdFJlcSBhcyBDdXN0b21BY3Rpb25SZXF1ZXN0fVxuICAgICAgICAgIC8+XG4gICAgICAgICl9XG4gICAgICA8L2Rpdj5cbiAgICA8L2Rpdj5cbiAgKTtcbn1cbiJdfQ==