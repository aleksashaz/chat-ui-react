"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.MuiChat = MuiChat;

var _core = require("@material-ui/core");

var _react = _interopRequireDefault(require("react"));

var _MuiAudioInput = require("./MuiAudioInput");

var _MuiFileInput = require("./MuiFileInput");

var _MuiMessage = require("./MuiMessage");

var _MuiMultiSelectInput = require("./MuiMultiSelectInput");

var _MuiSelectInput = require("./MuiSelectInput");

var _MuiTextInput = require("./MuiTextInput");

const useStyles = (0, _core.makeStyles)(theme => ({
  container: {
    height: '100%',
    width: '100%',
    padding: theme.spacing(1),
    backgroundColor: theme.palette.background.default,
    display: 'flex',
    flexDirection: 'column',
    '& > *': {
      maxWidth: '100%'
    },
    '& > * + *': {
      marginTop: theme.spacing(1)
    }
  },
  messages: {
    flex: '1 1 0%',
    overflowY: 'auto',
    WebkitOverflowScrolling: 'touch',
    display: 'flex',
    flexDirection: 'column',
    '& > *': {
      maxWidth: '100%'
    }
  },
  action: {
    flex: '0 1 auto',
    display: 'flex',
    alignContent: 'flex-end',
    '& > *': {
      minWidth: 0
    }
  }
}));

function MuiChat({
  chatController
}) {
  const classes = useStyles();
  const chatCtl = chatController;

  const [messages, setMessages] = _react.default.useState(chatCtl.getMessages());

  const [actReq, setActReq] = _react.default.useState(chatCtl.getActionRequest());

  const msgRef = _react.default.useRef(null);

  const scroll = _react.default.useCallback(() => {
    if (msgRef.current) {
      msgRef.current.scrollTop = msgRef.current.scrollHeight; // msgRef.current.scrollIntoView(true);
    }
  }, [msgRef]);

  _react.default.useEffect(() => {
    function handleMassagesChanged() {
      setMessages([...chatCtl.getMessages()]);
      scroll();
    }

    function handleActionChanged() {
      setActReq(chatCtl.getActionRequest());
      scroll();
    }

    chatCtl.addOnMessagesChanged(handleMassagesChanged);
    chatCtl.addOnActionChanged(handleActionChanged);
  }, [chatCtl, scroll]);

  const CustomComponent = _react.default.useMemo(() => {
    if (!actReq || actReq.type !== 'custom') {
      return null;
    }

    return actReq.Component;
  }, [actReq]);

  const unknownMsg = {
    type: 'text',
    content: 'Unknown message.',
    self: false
  };
  return /*#__PURE__*/_react.default.createElement("div", {
    className: classes.container
  }, /*#__PURE__*/_react.default.createElement("div", {
    className: classes.messages,
    ref: msgRef
  }, messages.map(msg => {
    if (msg.type === 'text' || msg.type === 'jsx' || msg.type === 'text_audio') {
      return /*#__PURE__*/_react.default.createElement(_MuiMessage.MuiMessage, {
        key: messages.indexOf(msg),
        id: `cu-msg-${messages.indexOf(msg) + 1}`,
        message: msg,
        showDateTime: !!chatCtl.getOption().showDateTime
      });
    }

    return /*#__PURE__*/_react.default.createElement(_MuiMessage.MuiMessage, {
      key: messages.indexOf(msg),
      id: `cu-msg-${messages.indexOf(msg) + 1}`,
      message: unknownMsg,
      showDateTime: !!chatCtl.getOption().showDateTime
    });
  })), /*#__PURE__*/_react.default.createElement("div", {
    className: classes.action
  }, actReq && actReq.type === 'text' && /*#__PURE__*/_react.default.createElement(_MuiTextInput.MuiTextInput, {
    chatController: chatCtl,
    actionRequest: actReq
  }), actReq && actReq.type === 'select' && /*#__PURE__*/_react.default.createElement(_MuiSelectInput.MuiSelectInput, {
    chatController: chatCtl,
    actionRequest: actReq
  }), actReq && actReq.type === 'multi-select' && /*#__PURE__*/_react.default.createElement(_MuiMultiSelectInput.MuiMultiSelectInput, {
    chatController: chatCtl,
    actionRequest: actReq
  }), actReq && actReq.type === 'file' && /*#__PURE__*/_react.default.createElement(_MuiFileInput.MuiFileInput, {
    chatController: chatCtl,
    actionRequest: actReq
  }), actReq && actReq.type === 'audio' && /*#__PURE__*/_react.default.createElement(_MuiAudioInput.MuiAudioInput, {
    chatController: chatCtl,
    actionRequest: actReq
  }), actReq && actReq.type === 'custom' && /*#__PURE__*/_react.default.createElement(CustomComponent, {
    chatController: chatCtl,
    actionRequest: actReq
  })));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9tdWkvTXVpQ2hhdC50c3giXSwibmFtZXMiOlsidXNlU3R5bGVzIiwidGhlbWUiLCJjb250YWluZXIiLCJoZWlnaHQiLCJ3aWR0aCIsInBhZGRpbmciLCJzcGFjaW5nIiwiYmFja2dyb3VuZENvbG9yIiwicGFsZXR0ZSIsImJhY2tncm91bmQiLCJkZWZhdWx0IiwiZGlzcGxheSIsImZsZXhEaXJlY3Rpb24iLCJtYXhXaWR0aCIsIm1hcmdpblRvcCIsIm1lc3NhZ2VzIiwiZmxleCIsIm92ZXJmbG93WSIsIldlYmtpdE92ZXJmbG93U2Nyb2xsaW5nIiwiYWN0aW9uIiwiYWxpZ25Db250ZW50IiwibWluV2lkdGgiLCJNdWlDaGF0IiwiY2hhdENvbnRyb2xsZXIiLCJjbGFzc2VzIiwiY2hhdEN0bCIsInNldE1lc3NhZ2VzIiwiUmVhY3QiLCJ1c2VTdGF0ZSIsImdldE1lc3NhZ2VzIiwiYWN0UmVxIiwic2V0QWN0UmVxIiwiZ2V0QWN0aW9uUmVxdWVzdCIsIm1zZ1JlZiIsInVzZVJlZiIsInNjcm9sbCIsInVzZUNhbGxiYWNrIiwiY3VycmVudCIsInNjcm9sbFRvcCIsInNjcm9sbEhlaWdodCIsInVzZUVmZmVjdCIsImhhbmRsZU1hc3NhZ2VzQ2hhbmdlZCIsImhhbmRsZUFjdGlvbkNoYW5nZWQiLCJhZGRPbk1lc3NhZ2VzQ2hhbmdlZCIsImFkZE9uQWN0aW9uQ2hhbmdlZCIsIkN1c3RvbUNvbXBvbmVudCIsInVzZU1lbW8iLCJ0eXBlIiwiQ29tcG9uZW50IiwidW5rbm93bk1zZyIsImNvbnRlbnQiLCJzZWxmIiwibWFwIiwibXNnIiwiaW5kZXhPZiIsImdldE9wdGlvbiIsInNob3dEYXRlVGltZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBYUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsU0FBUyxHQUFHLHNCQUFZQyxLQUFELEtBQW1CO0FBQzlDQyxFQUFBQSxTQUFTLEVBQUU7QUFD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LCBtYWtlU3R5bGVzIH0gZnJvbSAnQG1hdGVyaWFsLXVpL2NvcmUnO1xuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcblxuaW1wb3J0IHsgQ2hhdENvbnRyb2xsZXIgfSBmcm9tICcuLi9jaGF0LWNvbnRyb2xsZXInO1xuaW1wb3J0IHtcbiAgQWN0aW9uUmVxdWVzdCxcbiAgQXVkaW9BY3Rpb25SZXF1ZXN0LFxuICBDdXN0b21BY3Rpb25SZXF1ZXN0LFxuICBGaWxlQWN0aW9uUmVxdWVzdCxcbiAgTXVsdGlTZWxlY3RBY3Rpb25SZXF1ZXN0LFxuICBTZWxlY3RBY3Rpb25SZXF1ZXN0LFxuICBUZXh0QWN0aW9uUmVxdWVzdCxcbn0gZnJvbSAnLi4vY2hhdC10eXBlcyc7XG5cbmltcG9ydCB7IE11aUF1ZGlvSW5wdXQgfSBmcm9tICcuL011aUF1ZGlvSW5wdXQnO1xuaW1wb3J0IHsgTXVpRmlsZUlucHV0IH0gZnJvbSAnLi9NdWlGaWxlSW5wdXQnO1xuaW1wb3J0IHsgTXVpTWVzc2FnZSB9IGZyb20gJy4vTXVpTWVzc2FnZSc7XG5pbXBvcnQgeyBNdWlNdWx0aVNlbGVjdElucHV0IH0gZnJvbSAnLi9NdWlNdWx0aVNlbGVjdElucHV0JztcbmltcG9ydCB7IE11aVNlbGVjdElucHV0IH0gZnJvbSAnLi9NdWlTZWxlY3RJbnB1dCc7XG5pbXBvcnQgeyBNdWlUZXh0SW5wdXQgfSBmcm9tICcuL011aVRleHRJbnB1dCc7XG5cbmNvbnN0IHVzZVN0eWxlcyA9IG1ha2VTdHlsZXMoKHRoZW1lOiBUaGVtZSkgPT4gKHtcbiAgY29udGFpbmVyOiB7XG4gICAgaGVpZ2h0OiAnMTAwJScsXG4gICAgd2lkdGg6ICcxMDAlJyxcbiAgICBwYWRkaW5nOiB0aGVtZS5zcGFjaW5nKDEpLFxuICAgIGJhY2tncm91bmRDb2xvcjogdGhlbWUucGFsZXR0ZS5iYWNrZ3JvdW5kLmRlZmF1bHQsXG4gICAgZGlzcGxheTogJ2ZsZXgnLFxuICAgIGZsZXhEaXJlY3Rpb246ICdjb2x1bW4nLFxuICAgICcmID4gKic6IHtcbiAgICAgIG1heFdpZHRoOiAnMTAwJScsXG4gICAgfSxcbiAgICAnJiA+ICogKyAqJzoge1xuICAgICAgbWFyZ2luVG9wOiB0aGVtZS5zcGFjaW5nKDEpLFxuICAgIH0sXG4gIH0sXG4gIG1lc3NhZ2VzOiB7XG4gICAgZmxleDogJzEgMSAwJScsXG4gICAgb3ZlcmZsb3dZOiAnYXV0bycsXG4gICAgV2Via2l0T3ZlcmZsb3dTY3JvbGxpbmc6ICd0b3VjaCcsXG4gICAgZGlzcGxheTogJ2ZsZXgnLFxuICAgIGZsZXhEaXJlY3Rpb246ICdjb2x1bW4nLFxuICAgICcmID4gKic6IHtcbiAgICAgIG1heFdpZHRoOiAnMTAwJScsXG4gICAgfSxcbiAgfSxcbiAgYWN0aW9uOiB7XG4gICAgZmxleDogJzAgMSBhdXRvJyxcbiAgICBkaXNwbGF5OiAnZmxleCcsXG4gICAgYWxpZ25Db250ZW50OiAnZmxleC1lbmQnLFxuICAgICcmID4gKic6IHtcbiAgICAgIG1pbldpZHRoOiAwLFxuICAgIH0sXG4gIH0sXG59KSk7XG5cbmV4cG9ydCBmdW5jdGlvbiBNdWlDaGF0KHtcbiAgY2hhdENvbnRyb2xsZXIsXG59OiBSZWFjdC5Qcm9wc1dpdGhDaGlsZHJlbjx7XG4gIGNoYXRDb250cm9sbGVyOiBDaGF0Q29udHJvbGxlcjtcbn0+KTogUmVhY3QuUmVhY3RFbGVtZW50IHtcbiAgY29uc3QgY2xhc3NlcyA9IHVzZVN0eWxlcygpO1xuICBjb25zdCBjaGF0Q3RsID0gY2hhdENvbnRyb2xsZXI7XG4gIGNvbnN0IFttZXNzYWdlcywgc2V0TWVzc2FnZXNdID0gUmVhY3QudXNlU3RhdGUoY2hhdEN0bC5nZXRNZXNzYWdlcygpKTtcbiAgY29uc3QgW2FjdFJlcSwgc2V0QWN0UmVxXSA9IFJlYWN0LnVzZVN0YXRlKGNoYXRDdGwuZ2V0QWN0aW9uUmVxdWVzdCgpKTtcblxuICBjb25zdCBtc2dSZWYgPSBSZWFjdC51c2VSZWY8SFRNTERpdkVsZW1lbnQ+KG51bGwpO1xuICBjb25zdCBzY3JvbGwgPSBSZWFjdC51c2VDYWxsYmFjaygoKTogdm9pZCA9PiB7XG4gICAgaWYgKG1zZ1JlZi5jdXJyZW50KSB7XG4gICAgICBtc2dSZWYuY3VycmVudC5zY3JvbGxUb3AgPSBtc2dSZWYuY3VycmVudC5zY3JvbGxIZWlnaHQ7XG4gICAgICAvLyBtc2dSZWYuY3VycmVudC5zY3JvbGxJbnRvVmlldyh0cnVlKTtcbiAgICB9XG4gIH0sIFttc2dSZWZdKTtcbiAgUmVhY3QudXNlRWZmZWN0KCgpID0+IHtcbiAgICBmdW5jdGlvbiBoYW5kbGVNYXNzYWdlc0NoYW5nZWQoKTogdm9pZCB7XG4gICAgICBzZXRNZXNzYWdlcyhbLi4uY2hhdEN0bC5nZXRNZXNzYWdlcygpXSk7XG4gICAgICBzY3JvbGwoKTtcbiAgICB9XG4gICAgZnVuY3Rpb24gaGFuZGxlQWN0aW9uQ2hhbmdlZCgpOiB2b2lkIHtcbiAgICAgIHNldEFjdFJlcShjaGF0Q3RsLmdldEFjdGlvblJlcXVlc3QoKSk7XG4gICAgICBzY3JvbGwoKTtcbiAgICB9XG4gICAgY2hhdEN0bC5hZGRPbk1lc3NhZ2VzQ2hhbmdlZChoYW5kbGVNYXNzYWdlc0NoYW5nZWQpO1xuICAgIGNoYXRDdGwuYWRkT25BY3Rpb25DaGFuZ2VkKGhhbmRsZUFjdGlvbkNoYW5nZWQpO1xuICB9LCBbY2hhdEN0bCwgc2Nyb2xsXSk7XG5cbiAgdHlwZSBDdXN0b21Db21wb25lbnRUeXBlID0gUmVhY3QuRkM8e1xuICAgIGNoYXRDb250cm9sbGVyOiBDaGF0Q29udHJvbGxlcjtcbiAgICBhY3Rpb25SZXF1ZXN0OiBBY3Rpb25SZXF1ZXN0O1xuICB9PjtcbiAgY29uc3QgQ3VzdG9tQ29tcG9uZW50ID0gUmVhY3QudXNlTWVtbygoKTogQ3VzdG9tQ29tcG9uZW50VHlwZSA9PiB7XG4gICAgaWYgKCFhY3RSZXEgfHwgYWN0UmVxLnR5cGUgIT09ICdjdXN0b20nKSB7XG4gICAgICByZXR1cm4gbnVsbCBhcyB1bmtub3duIGFzIEN1c3RvbUNvbXBvbmVudFR5cGU7XG4gICAgfVxuICAgIHJldHVybiAoYWN0UmVxIGFzIEN1c3RvbUFjdGlvblJlcXVlc3QpXG4gICAgICAuQ29tcG9uZW50IGFzIHVua25vd24gYXMgQ3VzdG9tQ29tcG9uZW50VHlwZTtcbiAgfSwgW2FjdFJlcV0pO1xuXG4gIGNvbnN0IHVua25vd25Nc2cgPSB7XG4gICAgdHlwZTogJ3RleHQnLFxuICAgIGNvbnRlbnQ6ICdVbmtub3duIG1lc3NhZ2UuJyxcbiAgICBzZWxmOiBmYWxzZSxcbiAgfTtcblxuICByZXR1cm4gKFxuICAgIDxkaXYgY2xhc3NOYW1lPXtjbGFzc2VzLmNvbnRhaW5lcn0+XG4gICAgICA8ZGl2IGNsYXNzTmFtZT17Y2xhc3Nlcy5tZXNzYWdlc30gcmVmPXttc2dSZWZ9PlxuICAgICAgICB7bWVzc2FnZXMubWFwKChtc2cpOiBSZWFjdC5SZWFjdEVsZW1lbnQgPT4ge1xuICAgICAgICAgIGlmIChtc2cudHlwZSA9PT0gJ3RleHQnIHx8IG1zZy50eXBlID09PSAnanN4JyB8fCBtc2cudHlwZSA9PT0gJ3RleHRfYXVkaW8nKSB7XG4gICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICA8TXVpTWVzc2FnZVxuICAgICAgICAgICAgICAgIGtleT17bWVzc2FnZXMuaW5kZXhPZihtc2cpfVxuICAgICAgICAgICAgICAgIGlkPXtgY3UtbXNnLSR7bWVzc2FnZXMuaW5kZXhPZihtc2cpICsgMX1gfVxuICAgICAgICAgICAgICAgIG1lc3NhZ2U9e21zZ31cbiAgICAgICAgICAgICAgICBzaG93RGF0ZVRpbWU9eyEhY2hhdEN0bC5nZXRPcHRpb24oKS5zaG93RGF0ZVRpbWV9XG4gICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPE11aU1lc3NhZ2VcbiAgICAgICAgICAgICAga2V5PXttZXNzYWdlcy5pbmRleE9mKG1zZyl9XG4gICAgICAgICAgICAgIGlkPXtgY3UtbXNnLSR7bWVzc2FnZXMuaW5kZXhPZihtc2cpICsgMX1gfVxuICAgICAgICAgICAgICBtZXNzYWdlPXt1bmtub3duTXNnfVxuICAgICAgICAgICAgICBzaG93RGF0ZVRpbWU9eyEhY2hhdEN0bC5nZXRPcHRpb24oKS5zaG93RGF0ZVRpbWV9XG4gICAgICAgICAgICAvPlxuICAgICAgICAgICk7XG4gICAgICAgIH0pfVxuICAgICAgPC9kaXY+XG4gICAgICA8ZGl2IGNsYXNzTmFtZT17Y2xhc3Nlcy5hY3Rpb259PlxuICAgICAgICB7YWN0UmVxICYmIGFjdFJlcS50eXBlID09PSAndGV4dCcgJiYgKFxuICAgICAgICAgIDxNdWlUZXh0SW5wdXRcbiAgICAgICAgICAgIGNoYXRDb250cm9sbGVyPXtjaGF0Q3RsfVxuICAgICAgICAgICAgYWN0aW9uUmVxdWVzdD17YWN0UmVxIGFzIFRleHRBY3Rpb25SZXF1ZXN0fVxuICAgICAgICAgIC8+XG4gICAgICAgICl9XG4gICAgICAgIHthY3RSZXEgJiYgYWN0UmVxLnR5cGUgPT09ICdzZWxlY3QnICYmIChcbiAgICAgICAgICA8TXVpU2VsZWN0SW5wdXRcbiAgICAgICAgICAgIGNoYXRDb250cm9sbGVyPXtjaGF0Q3RsfVxuICAgICAgICAgICAgYWN0aW9uUmVxdWVzdD17YWN0UmVxIGFzIFNlbGVjdEFjdGlvblJlcXVlc3R9XG4gICAgICAgICAgLz5cbiAgICAgICAgKX1cbiAgICAgICAge2FjdFJlcSAmJiBhY3RSZXEudHlwZSA9PT0gJ211bHRpLXNlbGVjdCcgJiYgKFxuICAgICAgICAgIDxNdWlNdWx0aVNlbGVjdElucHV0XG4gICAgICAgICAgICBjaGF0Q29udHJvbGxlcj17Y2hhdEN0bH1cbiAgICAgICAgICAgIGFjdGlvblJlcXVlc3Q9e2FjdFJlcSBhcyBNdWx0aVNlbGVjdEFjdGlvblJlcXVlc3R9XG4gICAgICAgICAgLz5cbiAgICAgICAgKX1cbiAgICAgICAge2FjdFJlcSAmJiBhY3RSZXEudHlwZSA9PT0gJ2ZpbGUnICYmIChcbiAgICAgICAgICA8TXVpRmlsZUlucHV0XG4gICAgICAgICAgICBjaGF0Q29udHJvbGxlcj17Y2hhdEN0bH1cbiAgICAgICAgICAgIGFjdGlvblJlcXVlc3Q9e2FjdFJlcSBhcyBGaWxlQWN0aW9uUmVxdWVzdH1cbiAgICAgICAgICAvPlxuICAgICAgICApfVxuICAgICAgICB7YWN0UmVxICYmIGFjdFJlcS50eXBlID09PSAnYXVkaW8nICYmIChcbiAgICAgICAgICA8TXVpQXVkaW9JbnB1dFxuICAgICAgICAgICAgY2hhdENvbnRyb2xsZXI9e2NoYXRDdGx9XG4gICAgICAgICAgICBhY3Rpb25SZXF1ZXN0PXthY3RSZXEgYXMgQXVkaW9BY3Rpb25SZXF1ZXN0fVxuICAgICAgICAgIC8+XG4gICAgICAgICl9XG4gICAgICAgIHthY3RSZXEgJiYgYWN0UmVxLnR5cGUgPT09ICdjdXN0b20nICYmIChcbiAgICAgICAgICA8Q3VzdG9tQ29tcG9uZW50XG4gICAgICAgICAgICBjaGF0Q29udHJvbGxlcj17Y2hhdEN0bH1cbiAgICAgICAgICAgIGFjdGlvblJlcXVlc3Q9e2FjdFJlcSBhcyBDdXN0b21BY3Rpb25SZXF1ZXN0fVxuICAgICAgICAgIC8+XG4gICAgICAgICl9XG4gICAgICA8L2Rpdj5cbiAgICA8L2Rpdj5cbiAgKTtcbn1cbiJdfQ==